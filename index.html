<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JARVIS OS 21.0 - Adaptive Color</title>
<script src="https://js.puter.com/v2/"></script>
<style>
    :root {
        --cyan: #00f3ff;
        --cyan-dim: rgba(0, 243, 255, 0.1);
        --bg-color: #020408;
        --panel-bg: rgba(5, 10, 16, 0.85);
        --danger: #ff3333;
        --success: #33ff33;
    }

    body {
        margin: 0;
        background-color: var(--bg-color);
        font-family: "Consolas", "Courier New", monospace;
        overflow: hidden;
        height: 100vh;
        color: var(--cyan);
        text-shadow: 0 0 5px var(--cyan);
        user-select: none;
    }

    /* ================= BACKGROUND ================= */
    #quantum-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(circle at center, #05101a 0%, #000 100%); }
    .chip-texture {
        position: absolute; inset: 0; z-index: 1;
        background-image: linear-gradient(rgba(0, 243, 255, 0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.15) 1px, transparent 1px);
        background-size: 50px 50px; pointer-events: none;
        mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
    }

    /* ================= START OVERLAY ================= */
    #start-overlay {
        position: fixed; inset: 0; z-index: 5000;
        background: rgba(0,0,0,0.95);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .start-btn {
        padding: 20px 50px; background: transparent; border: 2px solid var(--cyan);
        color: var(--cyan); font-size: 24px; cursor: pointer; text-transform: uppercase;
        letter-spacing: 5px; box-shadow: 0 0 30px var(--cyan-dim); transition: 0.3s;
        font-family: inherit; font-weight: bold;
    }
    .start-btn:hover { background: var(--cyan); color: #000; box-shadow: 0 0 60px var(--cyan); }

    /* ================= MAIN INTERFACE ================= */
    #main-interface { position: absolute; inset: 0; z-index: 100; pointer-events: none; opacity: 0; transition: 1s; }
    .interface-active { opacity: 1 !important; }
    #hud-frame { position: absolute; inset: 15px; border: 1px solid rgba(0, 243, 255, 0.1); box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8); z-index: 50; }

    /* Profile */
    .profile-container { position: absolute; top: 30px; right: 40px; display: flex; align-items: center; gap: 10px; background: rgba(0, 20, 30, 0.9); padding: 5px 12px; border-radius: 50px; border: 1px solid var(--cyan); box-shadow: 0 0 15px rgba(0,0,0,0.5); pointer-events: auto; }
    .username { font-weight: bold; font-size: 12px; letter-spacing: 1px; }
    .profile-img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--cyan); object-fit: cover; }

    /* Core */
    .core-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; height: 450px; display: flex; justify-content: center; align-items: center; cursor: pointer; pointer-events: auto; }
    .ring-ticks { position: absolute; width: 420px; height: 420px; border-radius: 50%; border: 1px dashed rgba(0, 243, 255, 0.2); animation: rotateRight 80s linear infinite; pointer-events: none; }
    .ring-segmented { position: absolute; width: 340px; height: 340px; border-radius: 50%; border: 2px solid transparent; border-top: 2px solid var(--cyan); border-bottom: 2px solid var(--cyan); box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); animation: rotateLeft 30s linear infinite; pointer-events: none; }
    .ring-inner { position: absolute; width: 260px; height: 260px; border-radius: 50%; border: 5px dotted rgba(0, 243, 255, 0.4); animation: rotateRight 15s linear infinite; pointer-events: none; }
    .reactor { position: absolute; width: 140px; height: 140px; display: flex; justify-content: center; align-items: center; transition: 0.3s; z-index: 60; }
    .reactor:hover .reactor-glow { box-shadow: 0 0 80px var(--cyan); transform: scale(1.1); background: #fff; }
    .reactor-svg { position: absolute; width: 100%; height: 100%; animation: rotateLeft 10s linear infinite; }
    .reactor-glow { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, #fff 0%, var(--cyan) 50%, transparent 80%); border-radius: 50%; box-shadow: 0 0 50px var(--cyan); animation: pulseCore 2s ease-in-out infinite; transition: 0.3s; }
    
    .speaking .reactor-glow { box-shadow: 0 0 100px var(--cyan), 0 0 80px white; transform: scale(1.3); }
    .thinking .reactor-glow { background: radial-gradient(circle, #fff 0%, var(--danger) 50%, transparent 80%); box-shadow: 0 0 80px var(--danger); animation: pulseCore 0.2s infinite; }

    /* Panels */
    .panel { position: absolute; width: 260px; padding: 15px; background: var(--panel-bg); border: 1px solid var(--cyan); box-shadow: 0 0 20px rgba(0,0,0,0.8); backdrop-filter: blur(8px); pointer-events: auto; }
    .panel h3 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid var(--cyan-dim); letter-spacing: 2px; }
    .stat-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
    .left { top: 40%; left: 5%; transform: translateY(-50%); }
    .right { top: 40%; right: 5%; transform: translateY(-50%); }
    .graph-box { margin-top: 10px; height: 80px; width: 100%; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--cyan-dim); }
    .bar-box { display: flex; align-items: flex-end; justify-content: space-between; }
    .bar { width: 12px; background: var(--cyan); opacity: 0.9; transition: height 0.2s; }
    svg { width: 100%; height: 100%; display: block; }
    polyline { fill: none; stroke: var(--cyan); stroke-width: 2; vector-effect: non-scaling-stroke; }

    /* Transcript (The Text Box) */
    #transcript { 
        position: absolute; bottom: 80px; width: 60%; left: 20%; 
        text-align: center; font-size: 18px; color: #fff; 
        text-shadow: 0 0 5px var(--cyan); font-style: italic;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .footer { position: absolute; bottom: 30px; width: 100%; text-align: center; font-size: 12px; letter-spacing: 5px; z-index: 50; }

    /* HOLOGRAPHIC OVERLAY */
    #hologram-overlay { position: fixed; inset: 0; z-index: 3000; background: rgba(0, 5, 10, 0.95); backdrop-filter: blur(10px); display: none; opacity: 0; transition: opacity 0.5s ease; justify-content: center; align-items: center; }
    #hologram-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: move; }
    .holo-controls { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); text-align: center; pointer-events: none; }
    .holo-status { margin-bottom: 10px; font-size: 14px; letter-spacing: 3px; color: #fff; text-shadow: 0 0 10px var(--cyan); }
    .close-holo-btn { pointer-events: auto; background: transparent; border: 1px solid var(--cyan); color: var(--cyan); padding: 10px 30px; font-size: 16px; letter-spacing: 3px; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-family: inherit; background: rgba(0, 243, 255, 0.1); }
    .close-holo-btn:hover { background: var(--cyan); color: #000; box-shadow: 0 0 30px var(--cyan); }

    @keyframes rotateRight { 100% { transform: rotate(360deg); } }
    @keyframes rotateLeft { 100% { transform: rotate(-360deg); } }
    @keyframes pulseCore { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
    @keyframes barMove { 0% { height: 10%; } 100% { height: 90%; } }
</style>
</head>
<body>

<canvas id="quantum-canvas"></canvas>
<div class="chip-texture"></div>

<div id="start-overlay">
    <button class="start-btn" onclick="initSystem()">INITIALIZE SYSTEM</button>
</div>

<div id="hologram-overlay">
    <canvas id="hologram-canvas"></canvas>
    <div class="holo-controls">
        <div class="holo-status" id="holoStatus">TOPOLOGY: SPHERE</div>
        <div style="margin-bottom: 15px; font-size: 10px; color: #aaa;">DRAG TO ROTATE | COMMANDS: "RED", "BLUE", "CUBE"</div>
        <button class="close-holo-btn" onclick="closeHologram()">CLOSE PROJECTION</button>
    </div>
</div>

<div id="main-interface">
    <div id="hud-frame"></div>

    <div class="profile-container">
        <div class="username">COMMANDER</div>
        <img src="https://ui-avatars.com/api/?name=Stark&background=00f3ff&color=000&size=64&rounded=true&font-size=0.4" class="profile-img" alt="Profile">
    </div>

    <div class="core-container" onclick="openHologram()">
        <div class="ring-ticks"></div>
        <div class="ring-segmented"></div>
        <div class="ring-inner"></div>
        <div class="reactor" id="reactorCore">
            <svg class="reactor-svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="none" stroke="#00f3ff" stroke-width="1" />
                <path d="M50 5 L50 20 M50 80 L50 95 M5 50 L20 50 M80 50 L95 50" stroke="#00f3ff" stroke-width="2" />
                <circle cx="50" cy="50" r="25" fill="none" stroke="#00f3ff" stroke-width="2" stroke-dasharray="5,5" />
            </svg>
            <div class="reactor-glow"></div>
        </div>
    </div>

    <div class="panel left">
        <h3>SYS DIAGNOSTIC</h3>
        <div class="stat-row"><span>CPU</span><span id="cpuVal">45%</span></div>
        <div class="stat-row"><span>RAM</span><span id="memVal">4021 MB</span></div>
        <div class="graph-box"><svg viewBox="0 0 100 100" preserveAspectRatio="none"><polyline id="lineChart" points="0,100 100,100"></polyline></svg></div>
    </div>

    <div class="panel right">
        <h3>ENV METRICS</h3>
        <div class="stat-row"><span>TEMP</span><span>24Â°C</span></div>
        <div class="stat-row"><span>POWER</span><span>STABLE</span></div>
        <div class="graph-box bar-box" id="barChart"></div>
    </div>

    <div id="transcript">System Standby</div>
    <div class="footer">JARVIS SYSTEM ONLINE</div>
</div>

<script>
    function initSystem() {
        document.getElementById('start-overlay').style.display = 'none';
        document.getElementById('main-interface').classList.add('interface-active');
        speak("Online.");
        startVoiceEngine();
        initParticles(); animateBg();
        updateGraph();
    }

    /* ================= VOICE AI (STRICTLY CONCISE) ================= */
    let recognition; 
    let isJarvisActive = false;
    const reactor = document.getElementById('reactorCore');
    const transcriptDiv = document.getElementById('transcript');

    function startVoiceEngine() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SpeechRecognition) return;
        recognition = new SpeechRecognition(); recognition.continuous = true; recognition.lang = 'en-US'; recognition.interimResults = false;
        recognition.onstart = () => { transcriptDiv.innerText = "Listening..."; isJarvisActive = true; };
        recognition.onend = () => { if(isJarvisActive) recognition.start(); };
        recognition.onresult = (e) => {
            const cmd = e.results[e.results.length-1][0].transcript.toLowerCase().trim();
            transcriptDiv.innerText = `>> "${cmd}"`;
            processCommand(cmd);
        };
        recognition.start();
    }

    async function processCommand(cmd) {
        window.speechSynthesis.cancel();
        
        // Instant Commands
        if(cmd.includes("time")) { speak("It is " + new Date().toLocaleTimeString()); return; }
        if(cmd.includes("open google")) { speak("Opening Google"); window.open("https://google.com"); return; }
        if(cmd.includes("open hologram")) { openHologram(); return; }
        if(cmd.includes("close hologram")) { closeHologram(); return; }
        
        // Shape Commands
        if(cmd.includes("sphere")) { setShape('sphere'); return; }
        if(cmd.includes("cube")) { setShape('cube'); return; }
        if(cmd.includes("helix")) { setShape('helix'); return; }
        
        // Color Commands (Voice Activated)
        if(cmd.includes("red")) { holoColor = "255, 0, 0"; speak("Color set to Red."); return; }
        if(cmd.includes("blue") || cmd.includes("cyan")) { holoColor = "0, 243, 255"; speak("Color set to Cyan."); return; }
        if(cmd.includes("green")) { holoColor = "0, 255, 0"; speak("Color set to Green."); return; }

        // AI Brain (Puter.js)
        reactor.className = "reactor thinking";
        
        if (typeof puter !== 'undefined') {
            try {
                // STRICT PROMPT: FORCE 1 SENTENCE
                const response = await puter.ai.chat(`You are JARVIS. Answer in ONE short sentence. Maximum 15 words. No markdown. User: ${cmd}`);
                speak(response?.message?.content || response);
            } catch(e) {
                speak("I cannot connect to the cloud.");
                reactor.className = "reactor";
            }
        } else {
            speak("Offline mode active.");
            reactor.className = "reactor";
        }
    }

    function speak(text) {
        reactor.className = "reactor speaking"; 
        transcriptDiv.innerText = text;
        const u = new SpeechSynthesisUtterance(text);
        const v = window.speechSynthesis.getVoices().find(v => v.name.includes("Male") || v.name.includes("Google US English"));
        if(v) u.voice = v;
        u.onend = () => reactor.className = "reactor";
        window.speechSynthesis.speak(u);
    }

    /* ================= 3D HOLOGRAM (DEFAULT CYAN) ================= */
    const holoCanvas = document.getElementById('hologram-canvas');
    const holoCtx = holoCanvas.getContext('2d');
    const holoOverlay = document.getElementById('hologram-overlay');
    const holoStatus = document.getElementById('holoStatus');
    let holoActive = false; 
    let particles3D = []; 
    let rotation = { x: 0, y: 0 };
    let targetRotation = { x: 0, y: 0 };
    let isDragging = false;
    let lastMouse = { x: 0, y: 0 };
    
    // *** DEFAULT COLOR IS CYAN AGAIN ***
    let holoColor = "0, 243, 255"; 
    
    class Point3D {
        constructor() { 
            this.x=0;this.y=0;this.z=0; 
            this.tx=0;this.ty=0;this.tz=0; 
            this.setSphere(); 
            this.x=this.tx;this.y=this.ty;this.z=this.tz; 
        }

        setSphere() { 
            const t=Math.random()*Math.PI*2, p=Math.acos((Math.random()*2)-1), r=220; 
            this.tx=r*Math.sin(p)*Math.cos(t); this.ty=r*Math.sin(p)*Math.sin(t); this.tz=r*Math.cos(p); 
        }
        
        setCube() { 
            const s=160; 
            this.tx=(Math.random()-0.5)*2*s; this.ty=(Math.random()-0.5)*2*s; this.tz=(Math.random()-0.5)*2*s; 
        }

        setHelix() {
            const i = Math.random() * 20; 
            const t = i * 0.5 + Math.PI * (Math.random() > 0.5 ? 0 : 1);
            const r = 100;
            this.tx = r * Math.cos(t * 5);
            this.ty = (i - 10) * 30;
            this.tz = r * Math.sin(t * 5);
        }

        update() { 
            this.x+=(this.tx-this.x)*0.05; 
            this.y+=(this.ty-this.y)*0.05; 
            this.z+=(this.tz-this.z)*0.05; 
        }
    }

    function setShape(type) {
        if(!holoActive) openHologram();
        particles3D.forEach(p => { 
            if(type==='cube') p.setCube(); 
            else if(type==='helix') p.setHelix(); 
            else p.setSphere(); 
        });
        holoStatus.innerText = "TOPOLOGY: " + type.toUpperCase();
        speak("Morphing topology.");
    }

    function initHologram() {
        holoCanvas.width=window.innerWidth; holoCanvas.height=window.innerHeight; 
        particles3D=[];
        for(let i=0; i<400; i++) particles3D.push(new Point3D());
    }

    function animateHologram() {
        if(!holoActive) return;
        holoCtx.clearRect(0,0,holoCanvas.width,holoCanvas.height);
        
        const cx=holoCanvas.width/2, cy=holoCanvas.height/2;
        
        if(!isDragging) targetRotation.y += 0.005;
        rotation.x += (targetRotation.x - rotation.x) * 0.1;
        rotation.y += (targetRotation.y - rotation.y) * 0.1;

        let projected = [];
        
        particles3D.forEach(p => {
            p.update();
            let x1 = p.x*Math.cos(rotation.y) - p.z*Math.sin(rotation.y);
            let z1 = p.z*Math.cos(rotation.y) + p.x*Math.sin(rotation.y);
            let y1 = p.y*Math.cos(rotation.x) - z1*Math.sin(rotation.x);
            let z2 = z1*Math.cos(rotation.x) + p.y*Math.sin(rotation.x);
            let scale = 400/(400+z2);
            projected.push({x:cx+x1*scale, y:cy+y1*scale, z:z2, s:scale});
        });

        holoCtx.lineWidth = 0.5;
        for (let i = 0; i < projected.length; i++) {
            let p1 = projected[i];
            if(p1.s < 0.2) continue;

            // Using holoColor variable
            holoCtx.beginPath();
            holoCtx.fillStyle = `rgba(${holoColor},${p1.s})`;
            holoCtx.arc(p1.x, p1.y, 2*p1.s, 0, Math.PI*2);
            holoCtx.fill();

            for (let j = i + 1; j < projected.length; j++) {
                let p2 = projected[j];
                let dx = p1.x - p2.x;
                let dy = p1.y - p2.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 40 * p1.s) {
                    holoCtx.beginPath();
                    // Using holoColor variable
                    holoCtx.strokeStyle = `rgba(${holoColor},${0.3 * p1.s})`; 
                    holoCtx.moveTo(p1.x, p1.y);
                    holoCtx.lineTo(p2.x, p2.y);
                    holoCtx.stroke();
                }
            }
        }
        requestAnimationFrame(animateHologram);
    }

    holoCanvas.addEventListener('mousedown', e => { isDragging=true; lastMouse={x:e.clientX, y:e.clientY}; });
    window.addEventListener('mouseup', () => isDragging=false );
    window.addEventListener('mousemove', e => {
        if(!isDragging) return;
        let dx = e.clientX - lastMouse.x;
        let dy = e.clientY - lastMouse.y;
        targetRotation.y += dx * 0.01;
        targetRotation.x += dy * 0.01;
        lastMouse = {x:e.clientX, y:e.clientY};
    });

    function openHologram() { initHologram(); holoActive=true; holoOverlay.style.display='flex'; setTimeout(()=>holoOverlay.style.opacity=1,10); animateHologram(); speak("Hologram Active"); }
    function closeHologram() { holoOverlay.style.opacity=0; setTimeout(()=>{holoOverlay.style.display='none'; holoActive=false;},500); speak("Hologram Closed"); }

    /* ================= BACKGROUND & GRAPHS ================= */
    const canvas = document.getElementById('quantum-canvas');
    const ctx = canvas.getContext('2d');
    let width, height; let particles = [];
    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    
    function initParticles() { particles=[]; for(let i=0; i<Math.floor((width*height)/15000); i++) particles.push({x:Math.random()*width, y:Math.random()*height, vx:(Math.random()-0.5)*0.5, vy:(Math.random()-0.5)*0.5}); }
    function animateBg() {
        ctx.clearRect(0,0,width,height); ctx.strokeStyle='rgba(0,243,255,0.15)'; ctx.lineWidth=1;
        particles.forEach((p, i) => {
            p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>width)p.vx*=-1; if(p.y<0||p.y>height)p.vy*=-1;
            ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fillStyle='#00f3ff'; ctx.fill();
            for(let j=i+1; j<particles.length; j++) {
                let dx=p.x-particles[j].x, dy=p.y-particles[j].y;
                if(Math.sqrt(dx*dx+dy*dy)<150) { ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke(); }
            }
        });
        requestAnimationFrame(animateBg);
    }
